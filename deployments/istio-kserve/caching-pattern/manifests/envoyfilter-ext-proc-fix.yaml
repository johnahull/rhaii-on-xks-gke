apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: inference-pool-ext-proc-global-mode-fix
  namespace: opendatahub
spec:
  workloadSelector:
    labels:
      gateway.networking.k8s.io/gateway-name: inference-gateway
  priority: 25  # Higher priority than inference-pool-ext-proc-tpu-fix (20)
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.ext_proc
    patch:
      operation: MERGE
      value:
        typed_config:
          '@type': type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
          # Keep existing grpc_service and timeout from lower-priority filter
          failure_mode_allow: true
          # Set global processing_mode to enable ext_proc activation
          # Per-route configs will override these settings
          processing_mode:
            request_header_mode: SEND  # Enable ext_proc activation
            response_header_mode: SKIP
            request_body_mode: BUFFERED  # Enable body processing globally
            response_body_mode: NONE
          message_timeout: "1000s"
          metadata_options:
            forwarding_namespaces:
              untyped:
              - envoy.lb
            receiving_namespaces:
              untyped:
              - envoy.lb
